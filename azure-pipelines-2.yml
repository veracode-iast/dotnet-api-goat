# azure-pipelines.yml
trigger:
- master

variables:
- name: VERACODE_API_KEY_ID
  value: $(api_key_id)
- name: VERACODE_API_KEY_SECRET
  value: $(api_key_secret)

resources:
  containers:
  - container: 'iast_agent_server'
    image: 'veracode/iast-agent-server:latest'
    options: -e VERACODE_API_KEY_ID=$(api_key_id) -e VERACODE_API_KEY_SECRET=$(api_key_secret)
    ports:
    - 10010:10010

jobs:
- job: run_iast_agent_server
  displayName: Run the IAST Agent Server

  pool:
    vmImage: 'ubuntu-latest'

  services:
    iast_agent_server: iast_agent_server
  steps:
  - script: |
      echo 'Waiting for Agent Server to start'
      sleep 30
      DEBUG=1 curl -k -L https://0.0.0.0:10010/iast/as/v1
    displayName: Ping Agent Server

  - script: |
      echo 'Downloading Agent via /downloads endpoint'
      DEBUG=1 curl -k -L https://agent-server:10010/iast/as/v1/downloads | sh
    displayName: Download Agent

  - script: echo Building solution...
    displayName: Build

  - script: echo Testing with IAST...
    displayName: Test

  - script: echo Sending session_stop event...
    displayName: Send session_stop event

  - script: echo Getting results...
    displayName: Get results